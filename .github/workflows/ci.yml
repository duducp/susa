name: CI - Quality Assurance

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Show ShellCheck version
        run: shellcheck --version

      - name: Run ShellCheck on core files
        run: |
          echo "üîç Verificando core/susa..."
          shellcheck -x core/susa

      - name: Run ShellCheck on library files
        run: |
          echo "üîç Verificando bibliotecas..."
          find core/lib -name "*.sh" -type f | while read -r file; do
            echo "Verificando $file..."
            shellcheck -x "$file"
          done

      - name: Run ShellCheck on command scripts
        run: |
          echo "üîç Verificando comandos..."
          find commands -name "*.sh" -type f | while read -r file; do
            echo "Verificando $file..."
            shellcheck -x "$file"
          done

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Todos os scripts passaram na verifica√ß√£o do ShellCheck!"

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    needs: shellcheck

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install shfmt
        run: go install mvdan.cc/sh/v3/cmd/shfmt@latest

      - name: Show shfmt version
        run: shfmt -version

      - name: Run shfmt check
        run: |
          echo "üìù Verificando formata√ß√£o com shfmt..."
          shfmt -d -i 4 -ci core/susa core/lib/*.sh core/lib/internal/*.sh commands/**/*.sh install*.sh uninstall*.sh || {
            echo "‚ùå Problemas de formata√ß√£o encontrados"
            echo "üí° Execute 'make format' localmente para corrigir"
            exit 1
          }
          echo "‚úÖ Formata√ß√£o verificada com sucesso!"

      - name: Check for trailing whitespaces
        run: |
          if git grep -n '[[:space:]]$' -- '*.sh' ':!*.md'; then
            echo "‚ùå Encontrados espa√ßos em branco no final de linhas"
            exit 1
          fi
          echo "‚úÖ Nenhum espa√ßo em branco trailing encontrado"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, lint]
    if: always()

    steps:
      - name: Check status
        run: |
          if [ "${{ needs.shellcheck.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ]; then
            echo "‚úÖ Todos os checks passaram com sucesso!"
            exit 0
          else
            echo "‚ùå Alguns checks falharam:"
            echo "  - ShellCheck: ${{ needs.shellcheck.result }}"
            echo "  - Lint: ${{ needs.lint.result }}"
            exit 1
          fi
